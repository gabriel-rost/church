{% extends "base.html" %}

{% block content %}

{% load static %}

<link rel="stylesheet" href="{% static 'css/home.css' %}">

<script src="{% static 'js/home.js' %}"></script>

{% load webpush_notifications %}

{% webpush_header %}

<div class="container my-4">

    <div class="p-4 p-md-5 mb-4 text-white bg-primary rounded-3 shadow-sm position-relative overflow-hidden">
        <div class="col-md-10 px-0">
            {% if user.is_authenticated %}
            <h1 class="display-5 fw-bold">Bem-vindo(a) de volta, {{ user.username }}!</h1>
            {% if user.is_staff %}
            <div class="alert alert-info py-2 px-3 d-inline-flex align-items-center shadow-sm" role="alert"
                style="font-size: 0.9rem; border-radius: 50px;">
                <i class="bi bi-shield-check me-2"></i> <strong>Admin:</strong>&nbsp;Voc√™ tem acesso ao painel de
                controle.
            </div>
            {% endif %}
            <p class="lead my-3">Confira as √∫ltimas novidades e o que est√° acontecendo na nossa comunidade hoje.</p>

            <div class="d-flex flex-column align-items-start gap-3 mt-2">
                <a href="{% url 'profile_by_id' user_id=user.id %}"
                    class="btn btn-light btn-sm fw-bold px-4 rounded-pill">
                    Acessar Meu Perfil &rarr;
                </a>

                <div class="notification-wrapper" onclick="translateProcess()">
                    {% webpush_button %}
                </div>
            </div>

            {% else %}
            <h1 class="display-5 fw-bold">Bem-vindo(a) ao Church App</h1>
            <p class="lead my-3">Conecte-se com a comunidade, acompanhe eventos e leia posts inspiradores.</p>
            <a href="{% url 'login' %}" class="btn btn-light btn-sm mt-2">Fazer Login ou Cadastrar-se &rarr;</a>
            {% endif %}
        </div>
    </div>

    <div class="row g-4">

        <div class="col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column">
                    <div>
                        <h5 class="card-title fw-bold text-primary">üìö Navegar por T√≥picos</h5>
                        <p class="card-text text-muted small">Acesse feeds espec√≠ficos de conte√∫do.</p>
                    </div>
                    <div class="d-flex flex-wrap gap-2 mt-auto">
                        {% for channel in channels %}
                        <a href="{% url 'infinite_post_list' channel_pk=channel.id %}"
                            class="btn btn-outline-primary btn-sm rounded-pill">
                            #{{ channel.name }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column">
                    <div>
                        <h5 class="card-title fw-bold text-primary">üîç Busca Avan√ßada</h5>
                        <p class="card-text text-muted small">Encontre conte√∫dos e amigos na comunidade.</p>
                    </div>
                    <div class="d-flex flex-wrap gap-2 mt-auto">
                        <a href="{% url 'search_homepage' %}"
                            class="btn btn-outline-primary btn-sm rounded-pill">
                            Buscar Conte√∫do & Usu√°rios
                        </a>
                    </div>
                </div>
            </div>
        </div>

        {% if user.is_authenticated and user.is_staff %}
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card shadow-sm h-100 border-primary border-opacity-50">
                <div class="card-body d-flex flex-column justify-content-between">

                    <div>
                        <i class="bi bi-gear-fill text-primary display-6 mb-3"></i>
                        <h5 class="card-title fw-bold text-primary">Gerenciamento de Canais</h5>
                        <p class="card-text text-muted small mt-2">
                            Crie novos canais, edite nomes, ou gerencie membros e permiss√µes da comunidade.
                        </p>
                    </div>

                    <div class="mt-3">
                        <a href="{% url 'manage_channels' %}" class="btn btn-outline-primary w-100 fw-medium">
                            Acessar Painel Admin <i class="bi bi-arrow-right-short"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if user.is_authenticated and user.is_staff %}

        <div class="col-12 col-md-6 col-lg-4">
            <div class="card shadow-sm h-100 border-danger border-opacity-50">
                <div class="card-body d-flex flex-column justify-content-between">

                    <div>
                        <i class="bi bi-bell-fill text-danger display-6 mb-3"></i>
                        <h5 class="card-title fw-bold text-danger">Enviar Notifica√ß√£o</h5>
                        <p class="card-text text-muted small mt-2">
                            Envie avisos importantes para toda a comunidade com apenas um clique.
                        </p>
                    </div>
                    <div class="mt-3">
                        <a href="{% url 'send_notification' %}" class="btn btn-outline-danger w-100 fw-medium">
                            Enviar Notifica√ß√£o &nbsp; <i class="bi bi-arrow-right-short"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        {% endif %}

        <!-- <div class="col-lg-4">
            <div class="card shadow-sm h-100 bg-light">
                <div class="card-body d-flex flex-column justify-content-between">
                    <div>
                        <h5 class="card-title fw-bold text-success">üóìÔ∏è Pr√≥ximo Evento</h5>
                        
                        {% comment %}
                        A l√≥gica do evento deve ser reintroduzida aqui.
                        {% endcomment %}
                        
                        <p class="card-text">Nenhum evento agendado para os pr√≥ximos dias.</p>
                    </div>
                    <a href="#" class="card-link mt-auto">Ver Calend√°rio Completo</a>
                </div>
            </div>
        </div> -->

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100 overflow-hidden"
                style="border-radius: 20px; background: url('https://img.freepik.com/premium-photo/old-paper-texture-with-flecked-distressed-look-warm-parchment-vibe_380164-162804.jpg') center/cover;">

                <div class="card-body d-flex flex-column justify-content-between p-4 bg-white bg-opacity-75"
                    style="backdrop-filter: blur(1px);">

                    <div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-danger rounded-pill px-3 py-2 fw-bold small shadow-sm">
                                <i class="bi bi-fire me-1"></i> Destaque da Semana
                            </span>
                        </div>

                        {% with featured_post=featured_posts.0 %}
                        {% if featured_post %}
                        <h5 class="fw-bold text-dark mt-3 mb-1" style="font-family: 'Georgia', serif;">
                            {{ featured_post.post.content.title|truncatechars:60 }}
                        </h5>

                        <p class="text-muted small mb-3">
                            por <span class="fw-bold">{{ featured_post.post.user.username }}</span> ‚Ä¢ 4 min de leitura
                        </p>

                        <p class="card-text text-dark flex-grow-1 mb-4" style="font-style: italic; line-height: 1.5;">
                            "{{ featured_post.post.content.text|truncatechars:120 }}"
                        </p>

                        <div class="d-flex justify-content-end">
                            <a href="{% url 'post_detail' featured_post.post.id %}"
                                class="btn btn-dark rounded-pill px-4 fw-bold shadow-sm">
                                Ler agora
                            </a>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-journal-x fs-1 text-muted opacity-50"></i>
                            <p class="card-text text-muted mt-2">Nenhum destaque dispon√≠vel.</p>
                        </div>
                        {% endif %}
                        {% endwith %}
                    </div>

                    {% if posts %}
                    <div class="mt-4 pt-3 border-top border-dark border-opacity-10 text-center">
                        <a href="{% url 'infinite_post_list' channel_pk=1 %}"
                            class="text-decoration-none text-dark small fw-bold">
                            Ver Feed Completo <i class="bi bi-arrow-right ms-1"></i>
                        </a>
                    </div>
                    {% endif %}

                    {% if user.is_staff %}
                    <div class="mt-4 pt-3 border-top border-dark border-opacity-10 text-center">
                        <a href="" class="text-decoration-none text-danger small fw-bold">Remover Destaque</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- <div class="col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column justify-content-between">
                    
                    <div>
                        <h5 class="card-title fw-bold text-info">üöÄ √öltima Atualiza√ß√£o</h5>
                        <p class="card-text small text-muted">As novidades e melhorias mais recentes da plataforma.</p>
                        
                        {% comment %}
                        Assumimos que 'changelog_data' √© uma lista de commits ou releases e pegamos o primeiro item.
                        {% endcomment %}
                        {% if changelog_data and changelog_data|length > 0 %}
                            {% with latest_commit=changelog_data.0 %}
                                <p class="fw-medium mb-1">{{ latest_commit.message|truncatechars:70 }}</p>
                                
                                <p class="small text-muted mb-2">
                                    <i class="bi bi-clock me-1"></i> {{ latest_commit.date|date:"d/m/Y" }} | 
                                    <i class="bi bi-code me-1"></i> {{ latest_commit.sha }}
                                </p>
                                
                                <a href="{% url 'changelog' %}" class="card-link text-info">
                                    Ver Todos os Detalhes &rarr;
                                </a>
                            {% endwith %}
                        {% else %}
                            <p class="card-text">Nenhuma nota de atualiza√ß√£o dispon√≠vel no momento.</p>
                        {% endif %}
                    </div>
                    
                    <a href="{% url 'changelog' %}" class="card-link mt-auto">Ver P√°gina de Atualiza√ß√µes</a>
                </div>
            </div>
        </div> -->

    </div>
</div>

<h2 class="mt-5 mb-3 text-secondary">√öltimas Publica√ß√µes do Feed</h2>
<div class="row g-4">

    {% for post in posts %}

    <div class="col-12 col-md-6 col-lg-4">

        <div class="card shadow-sm h-100 border-0">
            <div class="card-body d-flex flex-column">

                <h5 class="fw-bold mb-3 text-dark">
                    {{ post.content.title|truncatechars:50 }}
                </h5>

                <p class="card-text small text-muted flex-grow-1">
                    {{ post.content.text|truncatechars:120 }}
                </p>

                <div class="mt-3 pt-3 border-top d-flex justify-content-between align-items-center">

                    <div class="text-start">
                        <span class="badge bg-light text-primary border border-primary">
                            <i class="bi bi-tag-fill me-1"></i>
                            <a href="{% url 'infinite_post_list' channel_pk=post.channel.id %}"
                                class="text-decoration-none text-primary">
                                #{{ post.channel.name }}
                            </a>
                        </span>
                    </div>

                    <a href="{% url 'post_detail' post.id %}" class="btn btn-sm btn-outline-primary ms-auto">
                        Ler &rarr;
                    </a>
                </div>
            </div>
        </div>

    </div>
    {% empty %}
    <div class="col-12">
        <p class="text-center text-muted p-5 border rounded bg-light">
            Nenhum post dispon√≠vel para esta se√ß√£o.
        </p>
    </div>
    {% endfor %}
</div>
</div>
{% endblock %}
{% extends "base.html" %}
{% block content %}

<link rel="javascript" href="church_project/church_app/templates/js/attachments.js">

<h1>Editar Post</h1>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.as_p }}

    <label for="id_attachments" class="btn btn-light mb-0">
        <i class="fas fa-camera"></i> Adicionar Novos Anexos
    </label>
    <input type="file" name="attachments" id="id_attachments" multiple class="d-none">
    <div id="file-preview" class="mt-3 d-flex flex-wrap gap-2"></div>
    
    <button type="submit" class="btn btn-primary">Salvar alteraÃ§Ãµes</button>
</form>

<h2>Anexos existentes</h2>
<ul>
    {% for attachment in archive %}
    <li>
        <a href="{{ attachment.file.url }}" target="_blank">
            ðŸ“Ž {{ attachment.filename }}
        </a>
        
        <form method="post" action="{% url 'remove_attachment' attachment.id %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-danger">Remover</button>
        </form>
    </li>
    {% empty %}
    <li>Sem anexos.</li>
    {% endfor %}
</ul>
<script> 
  document.addEventListener("DOMContentLoaded", function() {
    const input = document.getElementById("id_attachments");
    const preview = document.getElementById("file-preview");

    // mantÃ©m os arquivos em memÃ³ria
    let filesList = [];

    input.addEventListener("change", function() {
      // adiciona novos arquivos ao array existente
      filesList = [...filesList, ...Array.from(input.files)];

      // limpa o preview antes de redesenhar
      preview.innerHTML = "";

      // exibe todos os arquivos acumulados
      filesList.forEach((file, index) => {
        const fileContainer = document.createElement("div");
        fileContainer.classList.add("border", "p-2", "rounded", "text-center", "position-relative");
        fileContainer.style.width = "120px";

        // botÃ£o "x" para remover o arquivo
        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.innerHTML = "&times;";
        removeBtn.classList.add("btn", "btn-sm", "btn-danger", "position-absolute");
        removeBtn.style.top = "2px";
        removeBtn.style.right = "2px";
        removeBtn.onclick = () => {
          filesList.splice(index, 1);
          renderPreview();
        };

        if (file.type.startsWith("image/")) {
          const img = document.createElement("img");
          img.src = URL.createObjectURL(file);
          img.alt = file.name;
          img.classList.add("img-fluid", "rounded");
          img.style.maxHeight = "100px";
          fileContainer.appendChild(img);
        } else {
          const icon = document.createElement("i");
          icon.classList.add("fas", "fa-file-alt", "fa-3x", "text-secondary");
          const name = document.createElement("p");
          name.classList.add("small", "mt-1");
          name.textContent = file.name;
          fileContainer.appendChild(icon);
          fileContainer.appendChild(name);
        }

        fileContainer.appendChild(removeBtn);
        preview.appendChild(fileContainer);
      });

      // recria o input para refletir o estado atual da lista
      const dataTransfer = new DataTransfer();
      filesList.forEach(f => dataTransfer.items.add(f));
      input.files = dataTransfer.files;
    });

    function renderPreview() {
      preview.innerHTML = "";
      const dataTransfer = new DataTransfer();

      filesList.forEach((file, index) => {
        dataTransfer.items.add(file);

        const fileContainer = document.createElement("div");
        fileContainer.classList.add("border", "p-2", "rounded", "text-center", "position-relative");
        fileContainer.style.width = "120px";

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.innerHTML = "&times;";
        removeBtn.classList.add("btn", "btn-sm", "btn-danger", "position-absolute");
        removeBtn.style.top = "2px";
        removeBtn.style.right = "2px";
        removeBtn.onclick = () => {
          filesList.splice(index, 1);
          renderPreview();
        };

        if (file.type.startsWith("image/")) {
          const img = document.createElement("img");
          img.src = URL.createObjectURL(file);
          img.alt = file.name;
          img.classList.add("img-fluid", "rounded");
          img.style.maxHeight = "100px";
          fileContainer.appendChild(img);
        } else {
          const icon = document.createElement("i");
          icon.classList.add("fas", "fa-file-alt", "fa-3x", "text-secondary");
          const name = document.createElement("p");
          name.classList.add("small", "mt-1");
          name.textContent = file.name;
          fileContainer.appendChild(icon);
          fileContainer.appendChild(name);
        }

        fileContainer.appendChild(removeBtn);
        preview.appendChild(fileContainer);
      });

      input.files = dataTransfer.files;
    }
  });
</script>
{% endblock %}
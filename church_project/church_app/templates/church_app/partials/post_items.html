  {% for post in posts %}
  <div class="p-3 border-bottom post-tweet" data-id="{{ post.pk }}">
    
    <div class="d-flex align-items-baseline mb-1">
      <i class="bi bi-person-circle fs-6 me-2 text-secondary"></i>
      
      <h6 class="mb-0 me-2 fw-bold">{{ post.user.username }}</h6>
      
      <small class="text-muted">
        Â· {{ post.date|date:"d/m/Y H:i" }}
      </small>
    </div>
    
    {% if post %}

    {% if post.title %}
      <h6 class="fw-bold text-dark">{{ post.title }}</h6>
    {% endif %}

    <p class="mb-2 text-break">{{ post.text|linebreaksbr|urlize }}</p>

    {% if post.images.all or post.attachments.all %}
    <div class="mt-2">
      
      {% for image in post.images.all %}
      <img src="{{ image.ref }}" class="img-fluid w-100 rounded-3 mb-2" alt="Imagem do Post">
      {% endfor %}
      
      {% for attachment in post.attachments.all %}
      {% with attachment.file.url|lower as f %}
        
        {% if ".jpg" in f or ".jpeg" in f or ".png" in f or ".gif" in f %}
          <div class="text-center my-2">
            <img src="{{ attachment.file.url }}" alt="Anexo de Imagem" class="img-fluid rounded-3" style="max-height: 400px; max-width: 100%;">
          </div>
        
        {% else %}
        <div class="d-flex align-items-center p-2 mb-2 border rounded-3 bg-light">
          <i class="bi bi-file-earmark-arrow-down fs-6 me-2 text-primary"></i>
          <a href="{{ attachment.file.url }}" target="_blank" class="text-decoration-none text-dark small">
            ðŸ“Ž {{ attachment.file.name|cut:"archives/" }}
          </a>
        </div>
        {% endif %}
      {% endwith %}
      {% endfor %}
      
    </div>
    {% endif %}

    {% endif %}
    <div class="mt-2 px-2">
      <div class="d-flex gap-3 align-items-center">
        <button
          class="btn-insta-action p-0 border-0 bg-transparent {% if post.user_has_liked %}text-danger{% else %}text-dark{% endif %}"
          id="like-btn-{{ post.id }}" data-post="{{ post.id }}">
          <i class="bi {% if post.user_has_liked %}bi-heart-fill{% else %}bi-heart{% endif %} fs-4"></i>
        </button>

        <a href="{% url 'post_detail' post.id %}" class="text-dark p-0">
          <i class="bi bi-chat fs-4"></i>
        </a>

        <button class="btn-insta-action p-0 border-0 bg-transparent text-dark" 
                onclick="sharePost('Confira este post!', '{{ post.full_url }}')">
            <i class="bi bi-send fs-4"></i>
        </button>
      </div>

      <div class="mt-1">
        <span class="fw-bold small cursor-pointer" 
              id="count-{{ post.id }}" 
              onclick="loadLikers('{{ post.id }}')" 
              style="cursor: pointer;">
            {{ post.interactions.count }} curtida{{ post.interactions.count|pluralize }}
        </span>
      </div>
    </div>

    {% if user.is_authenticated and user.is_staff %}
        <div class="mt-2 d-block">
            <a href="{% url 'featured_post' post.id %}" 
              class="btn btn-sm btn-light text-secondary fw-medium border"
              title="Define esta publicaÃ§Ã£o como o Destaque da Semana na Home.">
                <i class="bi bi-star me-1"></i> Marcar como Destaque
            </a>
        </div>
    {% endif %}

  </div>
  {% empty %}
  <p>Nenhum post disponÃ­vel.</p>
  {% endfor %}


  <div class="modal fade" id="likersModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <h6 class="modal-title w-100 text-center fw-bold">Curtidas</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="likers-modal-body">
        </div>
      </div>
    </div>
  </div>

<script>
  function sharePost(title, url) {
    if (navigator.share) {
        navigator.share({
            title: title,
            url: url
        }).catch(console.error);
    } else {
        // Fallback: Copiar para a Ã¡rea de transferÃªncia
        navigator.clipboard.writeText(url);
        alert("Link copiado para a Ã¡rea de transferÃªncia!");
    }
}

document.querySelectorAll('.btn-insta-action[data-post]').forEach(button => {
    button.addEventListener('click', function() {
        const postId = this.getAttribute('data-post');
        
        fetch(`/post/${postId}/toggle_like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}', // Se estiver em arquivo JS separado, use a funÃ§Ã£o getCookie
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({})
        })
        .then(response => {
            if (!response.ok) throw new Error('Falha na requisiÃ§Ã£o');
            return response.json();
        })
        .then(data => {
            const likeBtn = document.getElementById(`like-btn-${postId}`);
            const countSpan = document.getElementById(`count-${postId}`);
            
            if (countSpan) {
                // LÃ³gica de pluralizaÃ§Ã£o correta
                const label = data.like_count === 1 ? 'curtida' : 'curtidas';
                countSpan.textContent = `${data.like_count} ${label}`;
            }

            if (likeBtn) {
                if (data.liked) {
                    likeBtn.classList.add('text-danger');
                    likeBtn.classList.remove('text-dark');
                    likeBtn.innerHTML = '<i class="bi bi-heart-fill fs-4 pulse-animation"></i>';
                } else {
                    likeBtn.classList.remove('text-danger');
                    likeBtn.classList.add('text-dark');
                    likeBtn.innerHTML = '<i class="bi bi-heart fs-4"></i>';
                }
            }
        })
        .catch(error => console.error('Erro ao curtir:', error));
    });
});

function loadLikers(postId) {
    const modalBody = document.getElementById('likers-modal-body');
    const myModal = new bootstrap.Modal(document.getElementById('likersModal'));
    
    modalBody.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-secondary"></div></div>';
    myModal.show();

    fetch(`/post/${postId}/likers/`)
        .then(response => response.text())
        .then(html => {
            modalBody.innerHTML = html;
        });
}
</script>

  <style>
    .btn-insta-action {
    transition: transform 0.1s ease-in-out;
    cursor: pointer;
    line-height: 1;
}

.btn-insta-action:active {
    transform: scale(1.2); /* Efeito de clique */
}

.text-danger {
    color: #ed4956 !important; /* Vermelho padrÃ£o Instagram */
}

/* Garante que o Ã­cone preenchido tenha um leve contorno se necessÃ¡rio */
.bi-heart-fill {
    animation: heartBeat 0.3s ease-in-out;
}

@keyframes heartBeat {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
}


/* Faz o contador de curtidas parecer um link interativo */
.cursor-pointer:hover {
    text-decoration: underline;
}

/* Deixa a lista de curtidores no modal mais limpa */
#likers-modal-body .list-group-item {
    padding: 0.75rem 0.5rem;
}
  </style>
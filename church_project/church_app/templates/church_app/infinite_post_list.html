{% extends "base.html" %}
{% block content %}

<div class="container my-4">

    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
        <a href="{% url 'home' %}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Voltar para a p√°gina inicial
        </a>
    
        <a href="{% url 'create_post' channel_pk=channel.id %}" class="btn btn-primary shadow-sm">
        <i class="bi bi-pencil"></i> Criar Novo Post
        </a>
    </div> 

  <h1 class="mb-4">Posts Recentes</h1>

  <!-- Container dos posts -->
  <div id="post-container">
    {% include "church_app/partials/post_items.html" %}
  </div>

  <!-- Loading -->
  <div id="loading" class="text-center my-4 d-none">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Carregando...</span>
    </div>
  </div>

</div>

<script>
let page = 2;
let loading = false;
let hasNext = true;

function pageIsScrollable() {
  return document.body.scrollHeight > window.innerHeight;
}

function loadMorePosts() {
  if (loading || !hasNext) return;
  
  loading = true; // Trava imediata
  document.getElementById("loading").classList.remove("d-none");

  fetch(`?page=${page}`, {
    headers: { "X-Requested-With": "XMLHttpRequest" }
  })
    .then(response => response.json())
    .then(data => {
      const container = document.getElementById("post-container");
      const tempDiv = document.createElement("div");
      tempDiv.innerHTML = data.html;

      // Filtra posts duplicados antes de inserir
      const newPosts = tempDiv.children;
      Array.from(newPosts).forEach(post => {
        const postId = post.getAttribute("data-id");
        if (!document.querySelector(`[data-id="${postId}"]`)) {
          container.appendChild(post);
        }
      });

      hasNext = data.has_next;
      page++;
      loading = false;
      document.getElementById("loading").classList.add("d-none");

      if (hasNext && !pageIsScrollable()) {
        loadMorePosts();
      }
    })
    .catch(() => {
      loading = false;
      document.getElementById("loading").classList.add("d-none");
    });
}

window.addEventListener("scroll", () => {
  const nearBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 500;
  if (nearBottom && !loading) {
    loadMorePosts();
  }
});

document.addEventListener("DOMContentLoaded", () => {
  if (hasNext && !pageIsScrollable()) {
    loadMorePosts();
  }
});
</script>

{% endblock %}
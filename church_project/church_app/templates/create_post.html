{% extends "base.html" %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
  <a href="javascript:history.back()" class="btn btn-outline-secondary btn-sm">
    <i class="bi bi-arrow-left"></i> Voltar
  </a>
</div>

<div class="card mb-3">
  <div class="card-body">
    <form id="postForm" method="POST" enctype="multipart/form-data">
      {% csrf_token %}

      {{ form.title }}

      <div class="form-group mb-3">
        {{ form.text }}
      </div>

      <div class="d-flex align-items-center gap-2 mb-3">
        <div id="js-error" class="alert alert-danger d-none"></div>
        <button type="submit" class="btn btn-primary">Post</button>

        <label for="id_attachments" class="btn btn-light mb-0">
          <i class="fas fa-camera"></i> Photo/File
        </label>
      </div>

      <input type="file" name="attachments" id="id_attachments" multiple class="d-none">

      <div id="file-preview" class="mt-3 d-flex flex-wrap gap-2"></div>

      {% if form.non_field_errors %}
      <div class="alert alert-danger mt-3">
        {{ form.non_field_errors }}
      </div>
      {% endif %}
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const input = document.getElementById("id_attachments");
  const preview = document.getElementById("file-preview");

  // mantém os arquivos em memória
  let filesList = [];

  input.addEventListener("change", function() {
    // adiciona novos arquivos ao array existente
    filesList = [...filesList, ...Array.from(input.files)];

    // limpa o preview antes de redesenhar
    preview.innerHTML = "";

    // exibe todos os arquivos acumulados
    filesList.forEach((file, index) => {
      const fileContainer = document.createElement("div");
      fileContainer.classList.add("border", "p-2", "rounded", "text-center", "position-relative");
      fileContainer.style.width = "120px";

      // botão "x" para remover o arquivo
      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.innerHTML = "&times;";
      removeBtn.classList.add("btn", "btn-sm", "btn-danger", "position-absolute");
      removeBtn.style.top = "2px";
      removeBtn.style.right = "2px";
      removeBtn.onclick = () => {
        filesList.splice(index, 1);
        renderPreview();
      };

      if (file.type.startsWith("image/")) {
        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        img.alt = file.name;
        img.classList.add("img-fluid", "rounded");
        img.style.maxHeight = "100px";
        fileContainer.appendChild(img);
      } else {
        const icon = document.createElement("i");
        icon.classList.add("fas", "fa-file-alt", "fa-3x", "text-secondary");
        const name = document.createElement("p");
        name.classList.add("small", "mt-1");
        name.textContent = file.name;
        fileContainer.appendChild(icon);
        fileContainer.appendChild(name);
      }

      fileContainer.appendChild(removeBtn);
      preview.appendChild(fileContainer);
    });

    // recria o input para refletir o estado atual da lista
    const dataTransfer = new DataTransfer();
    filesList.forEach(f => dataTransfer.items.add(f));
    input.files = dataTransfer.files;
  });

  function renderPreview() {
    preview.innerHTML = "";
    const dataTransfer = new DataTransfer();

    filesList.forEach((file, index) => {
      dataTransfer.items.add(file);

      const fileContainer = document.createElement("div");
      fileContainer.classList.add("border", "p-2", "rounded", "text-center", "position-relative");
      fileContainer.style.width = "120px";

      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.innerHTML = "&times;";
      removeBtn.classList.add("btn", "btn-sm", "btn-danger", "position-absolute");
      removeBtn.style.top = "2px";
      removeBtn.style.right = "2px";
      removeBtn.onclick = () => {
        filesList.splice(index, 1);
        renderPreview();
      };

      if (file.type.startsWith("image/")) {
        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        img.alt = file.name;
        img.classList.add("img-fluid", "rounded");
        img.style.maxHeight = "100px";
        fileContainer.appendChild(img);
      } else {
        const icon = document.createElement("i");
        icon.classList.add("fas", "fa-file-alt", "fa-3x", "text-secondary");
        const name = document.createElement("p");
        name.classList.add("small", "mt-1");
        name.textContent = file.name;
        fileContainer.appendChild(icon);
        fileContainer.appendChild(name);
      }

      fileContainer.appendChild(removeBtn);
      preview.appendChild(fileContainer);
    });

    input.files = dataTransfer.files;
  }
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {

    const form = document.getElementById("postForm");
    const title = document.getElementById("id_title");
    const text = document.getElementById("id_text");
    const attachments = document.getElementById("id_attachments");
    const errorBox = document.getElementById("js-error");

    form.addEventListener("submit", function(event) {

        const titleValue = title ? title.value.trim() : "";
        const textValue = text ? text.value.trim() : "";
        const filesCount = attachments.files.length;

        if (!titleValue && !textValue && filesCount === 0) {
            event.preventDefault();

            errorBox.classList.remove("d-none");
            errorBox.textContent = "O post não pode estar vazio.";

            return;
        }

        errorBox.classList.add("d-none");
    });

});
</script>
{% endblock %}

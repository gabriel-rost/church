{% extends "base.html" %}

{% block content %}

<div class="container py-3">
    <h5 class="mb-3">Visualizando Publicações de {{ channel.name }}</h5>

    <div id="feed"></div>

    <div id="loading" class="text-center py-3 d-none">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
</div>

<script>
let page = 1;
let loading = false;
let hasNext = true;

const feed = document.getElementById("feed");
const loadingEl = document.getElementById("loading");

function loadPosts() {
    if (loading || !hasNext) return;

    loading = true;
    loadingEl.classList.remove("d-none");

    fetch(`?page=${page}`, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(res => res.json())
    .then(data => {
        hasNext = data.has_next;
        renderPosts(data.posts);
        page++;
        loading = false;
        loadingEl.classList.add("d-none");
    })
    .catch(() => {
        loading = false;
        loadingEl.classList.add("d-none");
    });
}

function renderPosts(posts) {
    posts.forEach(post => {
        const div = document.createElement("div");
        div.className = "border-bottom py-3";

        div.innerHTML = `
            <strong>@${post.user}</strong>
            <small class="text-muted ms-2">${post.date}</small>

            ${post.title ? `<h6 class="mt-2">${post.title}</h6>` : ""}
            <p>${post.text}</p>

            ${post.attachments.map(a => `
                <div>
                    <a href="${a.url}" target="_blank">${a.name}</a>
                </div>
            `).join("")}
        `;

        feed.appendChild(div);
    });
}

// Scroll infinito
window.addEventListener("scroll", () => {
    if (
        window.innerHeight + window.scrollY
        >= document.body.offsetHeight - 300
    ) {
        loadPosts();
    }
});

// Primeira carga
document.addEventListener("DOMContentLoaded", loadPosts);

</script>

{% endblock %}
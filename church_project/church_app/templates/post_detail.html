{% extends "base.html" %}

{% block content %}
<div class="container my-5">
    
    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
        <a href="javascript:history.back()" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>

        {% if user.is_authenticated and user.is_staff %}
        <div>
            <a class="btn btn-outline-warning btn-sm me-2" href="{% url 'edit_post' post.id %}">
                <i class="bi bi-pencil"></i> Editar
            </a>
            <button id="delete_button" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-trash"></i> Excluir
            </button>
            <form id="delete_form" method="POST" action="{% url 'delete_post' post.id %}" style="display:none;">
                {% csrf_token %}
            </form>
        </div>
        {% endif %}
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            <h1 class="mb-3 fw-bold text-dark">{{ post.content.title }}</h1>
            
            <div class="d-flex align-items-center mb-4 text-muted border-bottom pb-3">
                <i class="bi bi-person-circle me-2 fs-5"></i>
                <small class="me-3">
                    Publicado por **{{ post.user.username }}**
                </small>
                <i class="bi bi-clock me-2"></i>
                <small>
                    em {{ post.date|date:"d/m/Y H:i" }}
                </small>
            </div>

            <p class="lead">{{ post.content.text }}</p>

            {% if post.content.attachments.all %}
            <div class="mt-3 mb-4">
                <div class="row g-3">
                {% for attachment in post.content.attachments.all %}
                    {% with attachment.file.url|lower as f %}
                        
                        {% if ".jpg" in f or ".jpeg" in f or ".png" in f or ".gif" in f %}
                        <div class="col-12">
                            <img src="{{ attachment.file.url }}" 
                                 alt="Anexo de Imagem" 
                                 class="img-fluid rounded-3 w-100 border" 
                                 style="max-height: 500px; object-fit: contain;">
                        </div>
                        {% else %}
                        <div class="col-12">
                            <div class="d-flex align-items-center p-2 border rounded-3 bg-light">
                                <i class="bi bi-file-earmark-arrow-down fs-6 me-2 text-primary"></i>
                                <a href="{{ attachment.file.url }}" target="_blank" class="text-decoration-none text-dark small fw-medium">
                                    {{ attachment.file.name|cut:"archives/" }}
                                </a>
                            </div>
                        </div>
                        {% endif %}
                        
                    {% endwith %}
                {% endfor %}
                </div>
            </div>
            {% endif %}

        </div>
    </div>
    
    <hr class="my-5">

    <div class="row justify-content-center">
        <div class="col-lg-8">
            {% include "comment/_comment_form.html" %}
            
            <hr class="mt-4 mb-4">
            
            {% include "comment/_comment_list.html" with comments=comments %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const deleteButton = document.getElementById('delete_button');
    const deleteForm = document.getElementById('delete_form');

    if (deleteButton && deleteForm) {
        deleteButton.addEventListener('click', function() {
            if (confirm('Tem certeza que deseja excluir esta publicação? Esta ação é irreversível.')) {
                deleteForm.submit();
            }
        });
    }
});
</script>
{% endblock %}